#import "../lib.typ": data-table

= 系统需求分析

== 业务流程分析

包裹入库是驿站管理的核心业务流程之一，其具体步骤如下:

+ 快递员将包裹送达驿站，工作人员扫描或手工录入快递单号；
+ 系统通过OCR技术自动识别收件人信息，或由工作人员手工补充；
+ 系统根据包裹大小自动调用货架分配算法，选择最优货架位置，包裹大小分为小、中、大三档；
+ 系统生成唯一的6位取件码并记录包裹状态为"待取件"，取件码格式为区域字母加5位随机字符；
+ 系统自动计算预计滞留时间用于后续滞留件管理，默认为入库后3天；
+ 系统通过短信或微信通知收件人取件码和货架位置；
+ 包裹放置到指定货架，完成入库流程。

#figure(
  include("../assets/flow-diagrams/parcel-checkin-flow.typ"),
  caption: [包裹入库业务流程图]
)

取件流程直接面向用户，要求快速准确，具体步骤如下:

+ 用户通过自助终端或向工作人员提供取件码和手机号后四位；
+ 系统验证取件码的有效性和手机号的匹配度；
+ 验证通过后，系统显示包裹详细信息和货架位置；
+ 工作人员根据货架位置取出包裹，核对包裹信息；
+ 用户确认包裹无误后签收，系统更新包裹状态为“已取件”，记录取件时间；
+ 系统自动释放货架空间，更新货架占用计数；
+ 如果该包裹有滞留记录，同步更新滞留记录状态。

#figure(
  include("../assets/flow-diagrams/parcel-pickup-flow.typ"),
  caption: [包裹取件业务流程图]
)

为避免包裹长期占用货架空间，系统设计了自动化的滞留件处理机制:

+ 系统定时任务于每天凌晨扫描所有未取件的包裹；
+ 识别超过预期取件时间的包裹，标记为“滞留”状态；
+ 系统自动创建滞留记录，记录滞留开始时间、提醒次数等信息；
+ 系统通过短信或微信向收件人发送滞留提醒，提醒尽快取件；
+ 每隔24小时重复发送提醒，最多提醒3次；
+ 如果包裹滞留超过7天且提醒无效，系统自动触发退回流程；
+ 工作人员将包裹退回原快递公司，更新包裹状态为"已退回";
+ 系统根据滞留天数自动计算滞留费用，超过免费期后每天收取1元。

#figure(
  include("../assets/flow-diagrams/overdue-process-flow.typ"),
  caption: [滞留件处理业务流程图]
)

驿站不仅提供取件服务，还支持用户寄件:

+ 用户通过系统填写寄件信息，包括收件人、地址、重量和体积；
+ 系统根据快递公司的价格配置，调用运费计算函数，自动计算运费；
+ 用户选择快递公司并确认寄件；
+ 系统生成寄件单号，记录寄件信息和运费；
+ 工作人员接收包裹，验证重量和体积；
+ 快递公司上门取件，系统更新寄件单状态为"已揽收"。

系统与四类外部实体进行交互：普通用户提交取件请求和寄件信息，并接收取件码和状态通知；驿站员工执行入库操作和状态更新，获取包裹信息和统计数据；快递员负责包裹投递；管理员进行系统配置并查看报表和日志。

#figure(
  include("../assets/flow-diagrams/dfd-context.typ"),
  caption: [驿站管理系统顶层数据流图]
)

== 功能需求

根据业务流程分析，系统需要实现以下功能模块:

#data-table(
  headers: ("功能模块", "功能说明"),
  ([用户管理], [支持用户名、手机号、身份证号注册；基于JWT的身份认证机制；区分普通用户、驿站员工、管理员三种角色；用户可查看和修改个人资料、修改密码]),
  ([包裹管理], [支持单个和批量入库，集成OCR识别；自动生成唯一的6位取件码；基于货架类型、容量、位置的智能分配算法；取件码验证、状态更新、货架释放；支持按取件码、快递单号、手机号等多种方式查询；包裹状态依次流转为已入库、待取件、已取件或滞留、退回，入库与上架分离支持暂存场景；滞留包裹的批量退回处理]),
  ([货架管理], [货架的增删改查操作；支持小、中、大三种类型货架；状态包括可用、维护中、已停用；实时跟踪货架当前占用数和剩余容量；按区域、类型统计货架利用率]),
  ([寄件管理], [录入寄件信息并选择快递公司；根据重量、体积、快递公司自动计算运费，支持首重续重、体积重量、附加费用等规则；查看寄件单列表和详情；用户寄件前可预估运费]),
  ([滞留件处理], [定时任务自动识别超期未取的包裹；通过短信/微信向用户发送提醒；基于滞留天数自动计算费用；支持批量处理滞留包裹退回]),
  ([统计分析], [运营仪表盘展示今日入库/取件/滞留数量、货架利用率等关键指标；按日期、快递公司、包裹大小等维度统计；货架利用率、负载分布统计；支持导出Excel/CSV格式的统计报表]),
  ([系统管理], [记录所有关键操作，支持审计和追溯；管理员可查看、管理所有用户，修改用户角色；配置滞留判定天数、提醒间隔、滞留费用标准等参数；维护快递公司信息和价格配置]),
)

== 非功能需求

首先，系统在性能方面需要满足响应时间、并发能力和数据规模三个维度的要求。响应时间方面，取件码查询响应时间应控制在100ms以内按P95标准，包裹列表查询响应时间应控制在200ms以内按P95标准，API接口平均响应时间应低于500ms。并发能力方面，系统需支持至少1000个并发用户同时在线，并能在高峰期如双十一等大促活动期间稳定处理每秒100+的包裹入库请求。数据规模方面，包裹表需支持千万级数据存储，分页查询在大数据量下仍应保持稳定性能。

其次，系统安全性设计涵盖身份认证、权限控制、数据安全、操作审计和数据备份五个层面。身份认证采用JWT Token机制，Token有效期为90天并支持刷新。权限控制基于RBAC模型，不同角色具有差异化的操作权限。数据安全方面，用户密码使用bcrypt加密存储，身份证号等敏感信息通过视图脱敏显示，同时使用参数化查询和ORM框架防护SQL注入攻击。系统记录所有敏感操作日志以支持审计追溯，并定期备份数据库防止数据丢失。

除此之外，系统采用无状态的应用服务设计，支持负载均衡和水平扩展。数据库层面支持读写分离和分片等扩展方案。各功能模块遵循松耦合原则，便于功能扩展和维护。API采用RESTful设计规范，便于第三方系统集成。代码遵循Go和TypeScript的编码规范，结构清晰易读。API文档通过Swagger自动生成，关键业务逻辑配有注释说明。日志系统采用分级设计，便于问题排查。单元测试覆盖率目标为70%以上，关键业务逻辑配有集成测试。版本控制使用Git，遵循Git Flow工作流。

在可用性要求方面，系统设计为7×24小时稳定运行，可用性目标≥99%。容错机制包括数据库连接池管理、请求超时控制和优雅降级策略。用户界面友好直观，操作流畅，响应及时，并支持主流浏览器。
