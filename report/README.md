# 校园"最后一公里"物流驿站管理系统 - 设计文档

本目录包含了《数据库系统实验》课程设计项目的完整设计文档。

## 项目概述

**项目名称**：校园"最后一公里"物流驿站管理系统

**技术栈**：
- 后端：Go + Gin + GORM + PostgreSQL
- 前端：Vue 3 + TypeScript + NaiveUI
- 架构：RESTful API + 分层架构

**核心功能**：
- 包裹入库（OCR识别、自动分配货架号）
- 取件码生成逻辑
- 滞留件处理
- 寄件运费计算
- 包裹状态流转（入库-上架-待取-已取-退回）
- 统计分析和报表

## 设计文档目录

### 📋 [01-系统整体架构设计.md](./01-系统整体架构设计.md)
完整的系统架构设计文档，包括：
- 技术选型和项目背景
- 三层架构设计（展示层、应用层、数据层）
- 核心功能模块划分
- 性能优化策略
- 安全性设计
- 部署架构
- 开发规范

**关键内容**：
- 分层架构模式（Handler → Service → Repository）
- 依赖注入设计（Google Wire）
- 核心业务模块（8个主要模块）
- 性能优化策略（数据库、应用、前端）

### 🗄️ 数据库设计文档（两个版本）

#### ⭐ [02-数据库设计（增强版）.md](./02-数据库设计（增强版）.md) **【推荐】**
**PostgreSQL高级特性增强版** - 充分体现数据库课程要求

**核心亮点**：
- ✅ **5个触发器**：自动维护货架计数、状态日志、时间计算、容量检查
- ✅ **6个存储过程/函数**：运费计算、货架分配、包裹入库/取件、取件码生成
- ✅ **5个视图**：统计分析、数据脱敏、业务查询简化
- ✅ **15+高级索引**：部分索引、复合索引、表达式索引、GIN/BRIN索引
- ✅ **20+CHECK约束**：数据完整性保证
- ✅ **分区表**：日志表按月分区，优化历史数据查询
- ✅ **事务控制**：隔离级别、保存点、行级锁

**高级特性应用统计**：
| 特性类型 | 数量 | 应用场景 |
|---------|------|----------|
| 触发器 | 5个 | 自动维护货架计数、状态日志、时间计算、容量检查 |
| 存储过程/函数 | 6个 | 运费计算、货架分配、包裹入库/取件、取件码生成 |
| 视图 | 5个 | 统计分析、数据脱敏、业务查询简化 |
| 高级索引 | 15+ | 部分索引、复合索引、表达式索引、GIN、BRIN |
| CHECK约束 | 20+ | 数据完整性保证 |
| 分区表 | 1个 | 日志表按月分区 |

**表结构设计**：
- users（用户表）- 完整约束示例
- parcels（包裹表）- 高级约束 + 时间逻辑约束
- shelves（货架表）- 容量限制约束
- courier_prices（快递价格配置表）
- shipments（寄件表）
- overdue_records（滞留记录表）
- operation_logs（操作日志表，分区表）

**业务逻辑下沉**：
- 核心业务逻辑通过存储过程实现（货架分配、包裹入库）
- 复杂计算通过函数封装（运费计算、滞留费用）
- 数据一致性通过触发器保证（货架计数、状态流转）
- 数据安全通过视图实现（脱敏、权限控制）

#### [02-数据库设计.md](./02-数据库设计.md) **【基础版】**
基础版数据库设计文档，包含：
- 概念结构设计（E-R图）
- 逻辑结构设计（关系模式）
- 物理结构设计（表结构、索引、约束）
- 基础触发器和索引策略

### 🔌 [03-API接口设计.md](./03-API接口设计.md)
完整的RESTful API接口文档，包括：
- 接口设计原则和规范
- 统一响应格式
- 错误码规范
- 40+个API接口详细定义

**接口模块**：
1. **用户模块**（5个接口）：注册、登录、个人信息管理
2. **包裹模块**（10个接口）：入库、取件、查询、退回
3. **货架模块**（6个接口）：CRUD、统计
4. **寄件模块**（4个接口）：下单、查询、运费计算
5. **滞留件模块**（3个接口）：列表、提醒、批量退回
6. **统计分析模块**（3个接口）：仪表盘、统计、导出
7. **系统管理模块**（5个接口）：日志、用户管理、配置

### ⚙️ 核心功能实现设计（两个版本）

#### ⭐ [04-核心功能实现设计（增强版）.md](./04-核心功能实现设计（增强版）.md) **【推荐】**
**数据库高级特性集成版** - 展示GORM与PostgreSQL协同

**核心内容**：
1. **包裹入库**：调用存储过程，触发器自动维护
2. **包裹取件**：事务控制 + 行级锁（FOR UPDATE）
3. **运费计算**：调用数据库函数
4. **统计查询**：使用视图 + 缓存策略
5. **滞留处理**：定时任务 + 视图 + 函数联动
6. **高性能查询**：索引优化、游标分页、全文搜索
7. **事务管理**：隔离级别、保存点、并发控制

**代码示例**：
- Repository层调用存储过程
- Service层事务管理
- 使用视图简化复杂查询
- 性能监控和调优

**设计模式总结**：
| 功能模块 | 数据库特性 | 应用层技术 | 优势 |
|---------|-----------|-----------|------|
| 包裹入库 | 存储过程 + 触发器 | GORM Raw SQL | 业务下沉、原子性 |
| 包裹取件 | 存储过程 + 行级锁 | 事务管理 | 并发安全 |
| 运费计算 | 函数 | 调用封装 | 逻辑一致性 |
| 统计查询 | 视图 + 物化视图 | 缓存策略 | 性能优化 |
| 滞留处理 | 视图 + 函数 + 触发器 | 定时任务 | 自动化 |

#### [04-核心功能实现设计.md](./04-核心功能实现设计.md) **【基础版】**
基础版实现设计，包含：
- 货架分配算法
- 取件码生成算法
- 运费计算算法
- 滞留件处理机制
- 状态流转控制

### 📅 [05-项目实施计划.md](./05-项目实施计划.md)
完整的项目开发计划和实施指南，包括：
- 6个开发阶段划分（25天计划）
- 详细的开发任务列表
- 技术难点和解决方案
- 风险管理策略
- 每日开发建议
- 交付物清单

**开发阶段**：
1. **Phase 1**：基础设施搭建（3天）
2. **Phase 2**：核心功能开发（10天）
3. **Phase 3**：高级功能开发（5天）
4. **Phase 4**：前端完善（3天）
5. **Phase 5**：测试与优化（4天）
6. **Phase 6**：部署与文档（3天）

## 设计亮点

### ⭐ 数据库高级特性深度应用（课程设计核心要求）

#### 1. 触发器（Triggers）- 5个
✅ **自动更新时间戳**：通用触发器自动维护 updated_at
✅ **货架计数维护**：包裹上架/取件自动更新货架占用数
✅ **状态变更日志**：包裹状态改变自动记录到操作日志
✅ **预计滞留时间**：包裹入库自动计算预计滞留时间
✅ **容量限制检查**：包裹分配前检查货架容量

#### 2. 存储过程/函数（Stored Procedures & Functions）- 6个
✅ **运费计算函数**：calculate_freight() - 首重续重、体积重量、附加费用
✅ **货架分配函数**：allocate_shelf() - 智能评分算法选择最优货架
✅ **包裹入库过程**：receive_parcel() - 完整入库流程（验证、分配、生成取件码）
✅ **包裹取件过程**：pickup_parcel() - 带行级锁的取件流程
✅ **取件码生成**：generate_pickup_code() - 唯一性保证的6位取件码
✅ **滞留费用计算**：calculate_overdue_fee() - 基于时间的费用计算

#### 3. 视图（Views）- 5个
✅ **包裹统计视图**：v_parcel_statistics - 按日期、状态、快递公司聚合
✅ **货架利用率视图**：v_shelf_utilization - 实时展示货架使用情况
✅ **用户包裹视图**：v_user_parcels - 数据脱敏、剩余时间计算
✅ **待处理滞留件视图**：v_pending_overdue_parcels - 滞留天数、费用计算
✅ **每日仪表盘视图**：v_daily_dashboard - 关键业务指标汇总

#### 4. 高级索引（Advanced Indexes）- 15+
✅ **部分索引**（Partial Index）：只索引未删除的数据，节省空间
✅ **复合索引**（Composite Index）：支持多条件查询和排序
✅ **表达式索引**（Expression Index）：支持函数查询（LOWER、DATE等）
✅ **GIN索引**（Generalized Inverted Index）：全文搜索（中文分词）
✅ **BRIN索引**（Block Range Index）：时间序列数据优化

#### 5. 事务控制（Transaction Control）
✅ **隔离级别设置**：SERIALIZABLE防止幻读
✅ **保存点（Savepoint）**：复杂事务的部分回滚
✅ **行级锁（FOR UPDATE）**：防止并发冲突（包裹取件场景）
✅ **咨询锁（Advisory Lock）**：防止定时任务重复执行

#### 6. 完整性约束（Integrity Constraints）- 20+
✅ **CHECK约束**：数据范围、格式、逻辑一致性检查
✅ **UNIQUE约束**：唯一性保证（用户名、手机号、取件码等）
✅ **外键约束**：引用完整性（ON DELETE策略）
✅ **时间逻辑约束**：上架时间 >= 入库时间，取件时间 >= 上架时间

#### 7. 分区表（Partitioning）
✅ **按月分区**：operation_logs 表按月分区，优化历史查询
✅ **自动分区管理**：通过脚本自动创建未来月份分区

### 2. 架构设计
✅ 清晰的分层架构，职责明确
✅ 依赖注入（Google Wire），提高可测试性
✅ RESTful API设计规范
✅ 统一的错误处理和响应格式
✅ GORM + PostgreSQL 协同，简化开发同时保证性能

### 3. 核心算法
✅ 智能货架分配算法（多因子评分，存储过程实现）
✅ 安全的取件码生成机制（数据库函数 + 唯一索引）
✅ 灵活的运费计算引擎（存储函数封装）
✅ 自动化的滞留件处理流程（定时任务 + 视图 + 触发器）

### 4. 性能优化
✅ 数据库索引优化（部分、复合、表达式、GIN、BRIN）
✅ 游标分页（适合大数据量，性能稳定）
✅ 物化视图（预计算复杂聚合）
✅ 业务逻辑下沉（存储过程减少网络往返）
✅ 缓存策略（Redis缓存视图结果）
✅ 异步处理（定时任务、消息队列）

### 5. 安全性
✅ JWT Token认证
✅ 基于角色的访问控制（RBAC）
✅ SQL注入防护（参数化查询、存储过程）
✅ 数据脱敏（视图实现）
✅ 操作日志审计（触发器自动记录）

## 技术指标

### 功能性指标
- ✅ 支持包裹全生命周期管理
- ✅ 自动分配货架，生成取件码
- ✅ 滞留件自动识别和处理
- ✅ 运费自动计算
- ✅ 多维度统计报表

### 性能指标
- ✅ 取件码查询 < 100ms
- ✅ 包裹列表查询 < 200ms
- ✅ 支持1000+并发用户
- ✅ 单表支持千万级数据

### 质量指标
- ✅ 单元测试覆盖率 > 80%
- ✅ 代码规范检查通过
- ✅ API文档完整（Swagger）
- ✅ 无严重安全漏洞

## 如何使用这些文档

### 💡 推荐学习路径

#### 对于开发者
1. **阅读架构** → [01-系统整体架构设计](./01-系统整体架构设计.md)
   - 了解系统整体架构和技术选型
   - 理解分层设计和核心模块

2. **学习数据库设计** → [02-数据库设计（增强版）](./02-数据库设计（增强版）.md) ⭐
   - 理解E-R图和关系模式
   - 学习PostgreSQL高级特性的应用
   - 重点关注：触发器、存储过程、视图、索引优化

3. **查阅API文档** → [03-API接口设计](./03-API接口设计.md)
   - 了解RESTful API规范
   - 查看各模块接口定义
   - 作为前后端开发的契约

4. **研究核心实现** → [04-核心功能实现设计（增强版）](./04-核心功能实现设计（增强版）.md) ⭐
   - 学习如何在GORM中调用存储过程
   - 理解事务控制和并发处理
   - 掌握性能优化技巧

5. **按计划开发** → [05-项目实施计划](./05-项目实施计划.md)
   - 按阶段逐步实现功能
   - 参考每日开发建议

### 📝 对于课程设计报告

设计文档可以直接作为课程设计报告的核心内容：

#### 报告结构映射

| 报告章节 | 参考文档 | 核心内容 |
|---------|---------|----------|
| **第1章：引言** | 01-系统整体架构设计 | 项目背景、技术选型、系统目标 |
| **第2章：需求分析** | 01-系统整体架构设计 | 核心功能模块、业务流程 |
| **第3章：数据库设计** | 02-数据库设计（增强版）⭐ | E-R图、关系模式、高级特性应用 |
| **第4章：详细设计与实现** | 03-API接口设计 + 04-核心功能实现（增强版）⭐ | API设计、核心算法、代码实现 |
| **第5章：系统测试** | 05-项目实施计划 | 测试策略、性能测试 |
| **第6章：总结** | README.md | 设计亮点、技术指标 |

#### ⭐ 特别注意：数据库高级特性

**课程要求：系统应能体现数据库高级特性的应用（触发器、存储过程、视图、事务控制、索引优化）**

在报告中重点突出以下内容（来自增强版文档）：

1. **触发器应用**（第3章）
   ```
   展示5个触发器的设计和实现：
   - 货架计数自动维护
   - 状态变更日志
   - 预计滞留时间计算
   - 容量限制检查
   - 时间戳自动更新
   ```

2. **存储过程/函数**（第3章 + 第4章）
   ```
   展示6个核心函数的设计：
   - receive_parcel() - 包裹入库完整流程
   - pickup_parcel() - 取件流程（含行级锁）
   - calculate_freight() - 运费计算
   - allocate_shelf() - 货架分配算法
   - generate_pickup_code() - 取件码生成
   - calculate_overdue_fee() - 滞留费用计算
   ```

3. **视图应用**（第3章 + 第4章）
   ```
   展示5个视图的作用：
   - v_parcel_statistics - 统计分析
   - v_shelf_utilization - 货架利用率
   - v_user_parcels - 数据脱敏
   - v_pending_overdue_parcels - 滞留件管理
   - v_daily_dashboard - 运营仪表盘
   ```

4. **索引优化**（第3章）
   ```
   展示15+种索引策略：
   - 部分索引（Partial Index）
   - 复合索引（Composite Index）
   - 表达式索引（Expression Index）
   - GIN索引（全文搜索）
   - BRIN索引（时间序列）
   ```

5. **事务控制**（第4章）
   ```
   展示并发控制机制：
   - 隔离级别设置（SERIALIZABLE）
   - 行级锁（FOR UPDATE）
   - 保存点（Savepoint）
   - 死锁处理
   ```

### 🔧 对于实际开发

#### 第一步：数据库初始化
```bash
cd backend

# 1. 创建数据库
createdb logistics_db

# 2. 执行初始化脚本（按顺序）
psql -d logistics_db -f sql/01_init.sql
psql -d logistics_db -f sql/02_tables.sql
psql -d logistics_db -f sql/03_indexes.sql
psql -d logistics_db -f sql/04_triggers.sql
psql -d logistics_db -f sql/05_functions.sql
psql -d logistics_db -f sql/06_views.sql
psql -d logistics_db -f sql/07_seed.sql
```

#### 第二步：后端开发
```bash
# 1. 安装依赖
go mod tidy

# 2. 生成Wire依赖注入代码
wire gen ./cmd/server/wire

# 3. 生成Swagger文档
make swag

# 4. 运行服务器
nunu run ./cmd/server
```

#### 第三步：前端开发
```bash
cd frontend

# 1. 安装依赖
bun install

# 2. 启动开发服务器
bun dev
```

### 💻 代码示例位置

增强版文档中包含大量可直接使用的代码：

- **SQL脚本**：02-数据库设计（增强版）.md
  - 所有表结构定义
  - 触发器完整代码
  - 存储过程/函数实现
  - 视图定义
  - 索引创建语句

- **Go代码**：04-核心功能实现设计（增强版）.md
  - Repository层调用存储过程
  - Service层事务管理
  - 使用视图查询
  - 性能优化示例

### 📊 性能测试参考

文档中包含的性能优化策略：

1. **查询性能对比**（04增强版）
   - 传统分页 vs 游标分页
   - 实时聚合 vs 物化视图
   - 普通索引 vs GIN索引

2. **并发测试要点**
   - 行级锁（FOR UPDATE）防止重复取件
   - 存储过程减少网络往返
   - 事务隔离级别选择

3. **监控指标**
   - 慢查询检测（>100ms）
   - 索引使用情况
   - 数据库连接池状态

## 相关文档链接

- [项目需求文档（TARGET.md）](../TARGET.md)
- [项目开发指南（CLAUDE.md）](../CLAUDE.md)
- [后端源码](../backend/)
- [前端源码](../frontend/)

## 数据库脚本

数据库初始化脚本位于：
```
backend/
├── sql/
│   ├── init.sql          # 数据库初始化脚本
│   ├── tables.sql        # 表结构创建脚本
│   ├── indexes.sql       # 索引创建脚本
│   └── seed.sql          # 测试数据脚本
```

## Swagger API文档

启动后端服务后，访问：
```
http://localhost:8000/swagger/index.html
```

## 联系方式

如有问题，请参考：
- 后端框架文档：[Nunu Framework](https://github.com/go-nunu/nunu)
- GORM文档：https://gorm.io/docs/
- Vue 3文档：https://vuejs.org/

---

**最后更新时间**：2025-12-01
**文档版本**：v1.0
