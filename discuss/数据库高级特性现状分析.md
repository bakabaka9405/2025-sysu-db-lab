# 数据库高级特性现状分析

> 分析时间: 2025-12-18
> 分析目的: 评估项目当前使用的数据库高级特性，对照课程要求和设计文档

## 一、课程要求回顾

根据 `TARGET.md` 第 15 行：
> 系统中应能体现对数据库高级特性的应用（如触发器、存储过程、视图、事务控制及索引优化）

## 二、当前已实现的特性 ✅

### 1. 事务控制 (Transaction)
- **实现位置**: `backend/internal/repository/repository.go:43-68`
- **实现方式**: 使用 GORM 的事务封装，支持 ACID 特性
- **应用场景**:
  - 包裹入库时同时更新货架计数 (`parcel.go:50-84`)
  - 包裹取件时同时释放货架空间 (`parcel.go:107-123`)
- **代码示例**:
```go
err := s.tm.Transaction(ctx, func(ctx context.Context) error {
    // 原子操作：创建包裹 + 更新货架
    if err := s.parcelRepo.Create(ctx, parcel); err != nil {
        return err
    }
    if err := s.shelfRepo.IncrementCount(ctx, shelf.ID); err != nil {
        return err
    }
    return nil
})
```

### 2. 索引优化
- **唯一索引**:
  - `tracking_number` (快递单号)
  - `pickup_code` (取件码)
  - `shelf_code` (货架编码)
- **普通索引**:
  - `recipient_phone` (收件人手机号)
  - `status` (包裹状态)
  - `received_at` (入库时间)
  - `shelf_id` (外键索引)
- **实现位置**: `backend/internal/model/parcel.go:33-51`

### 3. 完整性约束
- **主键约束**: 所有表都有 ID 主键
- **唯一性约束**: 快递单号、取件码、货架编码
- **外键约束**: `parcels.shelf_id -> shelves.id`
- **NOT NULL 约束**: 所有关键字段
- **软删除**: 使用 `DeletedAt` 实现逻辑删除

### 4. 递归 CTE (Common Table Expression)
- **实现位置**: `backend/internal/repository/parcel.go:179-212`
- **功能**: 生成日期序列，用于趋势数据统计
- **SQL 片段**:
```sql
WITH RECURSIVE dates AS (
    SELECT ? AS date
    UNION ALL
    SELECT date(date, '+1 day')
    FROM dates
    WHERE date < date('now', 'localtime')
)
SELECT dates.date, COUNT(p.*) as received, COUNT(p.picked_up_at) as picked_up
FROM dates LEFT JOIN parcels p ...
```

### 5. 聚合查询与统计分析
- `CountByStatus()`: GROUP BY 统计不同状态包裹数量
- `CountTodayReceived/PickedUp()`: 日期筛选统计
- `GetRecentTrends()`: 复杂的趋势分析查询
- **实现位置**: `backend/internal/repository/parcel.go:117-212`

### 6. 关联查询 (JOIN)
- 使用 GORM 的 Preload 实现预加载
- 包裹查询时自动加载关联的货架信息
- **代码示例**:
```go
err := r.DB(ctx).Preload("Shelf").First(&parcel, id).Error
```

## 三、计划但未实现的特性 ❌

> 以下特性在 `report/02-数据库设计（增强版）.md` 中有详细设计，但尚未实际实现

### 1. 触发器 (Triggers)
设计文档中计划的 5 个触发器：

| 触发器名 | 功能 | 设计位置 |
|---------|------|---------|
| `trg_users_update_timestamp` | 自动更新 updated_at | 设计文档 357-370 行 |
| `trg_maintain_shelf_count` | 货架占用数自动维护 | 设计文档 373-436 行 |
| `trg_log_parcel_status_change` | 状态变更日志记录 | 设计文档 439-472 行 |
| `trg_set_expected_overdue_time` | 自动计算滞留时间 | 设计文档 475-491 行 |
| `trg_check_shelf_capacity` | 货架容量检查 | 设计文档 494-523 行 |

**当前实现方式**: 货架计数维护在应用层通过事务手动处理 (Go 代码)

### 2. 存储过程和函数
设计文档中计划的 6 个函数/存储过程：

| 函数名 | 功能 | 设计位置 |
|-------|------|---------|
| `calculate_freight()` | 运费计算（含保价、回单费） | 设计文档 528-604 行 |
| `allocate_shelf()` | 智能货架分配算法 | 设计文档 607-650 行 |
| `receive_parcel()` | 包裹入库完整流程 | 设计文档 653-771 行 |
| `pickup_parcel()` | 包裹取件流程（含行级锁） | 设计文档 774-843 行 |
| `calculate_overdue_fee()` | 滞留费用计算 | 设计文档 847-868 行 |
| `generate_pickup_code()` | 取件码生成 | 设计文档 728-758 行 |

**当前实现方式**: 所有逻辑在应用层 Service 实现

### 3. 视图 (Views)
设计文档中计划的 5 个视图：

| 视图名 | 功能 | 设计位置 |
|-------|------|---------|
| `v_parcel_statistics` | 包裹统计聚合 | 设计文档 873-894 行 |
| `v_shelf_utilization` | 货架利用率实时监控 | 设计文档 897-921 行 |
| `v_user_parcels` | 用户包裹（数据脱敏） | 设计文档 924-959 行 |
| `v_pending_overdue_parcels` | 待处理滞留件 | 设计文档 962-988 行 |
| `v_daily_dashboard` | 每日运营仪表盘 | 设计文档 991-1024 行 |

**当前实现方式**: 通过 Repository 层的查询方法直接查询表

### 4. 高级索引策略
设计文档计划但未实现的索引类型：

- **部分索引** (Partial Index): 只索引 `deleted_at IS NULL` 的数据
- **表达式索引**: 如 `LOWER(username)`、`DATE(received_at)`
- **GIN 索引**: 全文搜索（备注字段）
- **BRIN 索引**: 时间序列数据（操作日志）

**当前实现**: 只有基础的 B-Tree 索引

### 5. 高级约束
设计文档计划的约束类型：

- **CHECK 约束**:
  - 手机号格式 `phone ~ '^1[3-9]\d{9}$'`
  - 取件码格式 `pickup_code ~ '^[A-Z][0-9A-Z]{5}$'`
  - 重量为正数 `weight > 0`
  - 状态值枚举
  - 时间逻辑 `picked_up_at >= shelved_at`
- **EXCLUDE 约束**: 防止货架超载

**当前实现**: 约束逻辑在应用层验证

### 6. 其他未实现特性
- **分区表**: 操作日志表按月分区
- **物化视图**: 月度统计缓存
- **行级锁**: `FOR UPDATE` 悲观锁
- **乐观锁**: 版本号机制
- **咨询锁**: Advisory Lock

## 四、差距分析

### 已实现 vs 设计文档

| 特性类型 | 设计文档 | 实际实现 | 实现率 |
|---------|---------|---------|-------|
| 事务控制 | ✓ | ✓ | 100% |
| 基础索引 | ✓ | ✓ | 100% |
| 完整性约束 | ✓ | 部分 | 40% |
| 触发器 | 5个 | 0个 | 0% |
| 存储过程/函数 | 6个 | 0个 | 0% |
| 视图 | 5个 | 0个 | 0% |
| 高级索引 | 15+ | 0个 | 0% |
| 分区表 | 1个 | 0个 | 0% |
| 并发控制 | 多种 | 基础 | 20% |

### 课程要求符合度

| 要求项 | 当前状态 | 说明 |
|-------|---------|------|
| 触发器 | ❌ 未实现 | 设计文档有，代码无 |
| 存储过程 | ❌ 未实现 | 设计文档有，代码无 |
| 视图 | ❌ 未实现 | 设计文档有，代码无 |
| 事务控制 | ✅ 已实现 | GORM 事务封装 |
| 索引优化 | ✅ 已实现 | 基础 B-Tree 索引 |

## 五、实现建议

### 优先级 1: 满足课程基本要求

为了体现数据库高级特性应用，建议最低实现：

1. **触发器 (1-2个)**
   - ✅ `trg_maintain_shelf_count`: 货架计数自动维护
   - ✅ `trg_set_expected_overdue_time`: 自动计算滞留时间

2. **存储过程/函数 (2-3个)**
   - ✅ `calculate_freight()`: 运费计算
   - ✅ `allocate_shelf()`: 货架分配算法
   - 可选: `calculate_overdue_fee()`: 滞留费用计算

3. **视图 (2-3个)**
   - ✅ `v_shelf_utilization`: 货架利用率
   - ✅ `v_user_parcels`: 数据脱敏视图
   - 可选: `v_daily_dashboard`: 运营仪表盘

### 优先级 2: 提升性能和健壮性

4. **高级索引 (3-5个)**
   - 部分索引: `WHERE deleted_at IS NULL`
   - 复合索引: `(status, received_at DESC)`
   - 表达式索引: `DATE(received_at)`

5. **CHECK 约束 (5-8个)**
   - 手机号格式验证
   - 取件码格式验证
   - 数值范围约束
   - 时间逻辑约束

### 优先级 3: 扩展特性（可选）

6. **并发控制**
   - 取件操作加行级锁 `FOR UPDATE`
   - 版本号乐观锁

7. **分区表**
   - 操作日志按月分区

## 六、实现方式建议

### 方案 A: 纯 SQL 实现（推荐）
- 创建 `backend/sql/` 目录
- 按功能分文件: `04_triggers.sql`, `05_functions.sql`, `06_views.sql`
- 在数据库迁移中执行

**优点**:
- 充分展示数据库高级特性
- 性能更好（逻辑下沉）
- 符合课程要求

**缺点**:
- 需要 PostgreSQL（当前用 SQLite）
- GORM 集成需要手动编写 Raw SQL

### 方案 B: GORM + 部分 SQL
- 保持应用层逻辑不变
- 仅添加视图和部分函数
- 触发器用于自动维护字段

**优点**:
- 改动较小
- 兼容 SQLite
- 开发效率高

**缺点**:
- 数据库特性展示不充分
- 性能提升有限

### 方案 C: 混合实现
- 核心业务逻辑保持在应用层
- 数据维护、统计、约束下沉到数据库
- 触发器: 货架计数、时间计算
- 视图: 统计、脱敏
- 函数: 运费计算、滞留费用

**优点**:
- 平衡开发效率和特性展示
- 实用性强
- 可演示多种特性

**缺点**:
- 架构相对复杂

## 七、决策建议

根据课程设计要求，推荐采用**方案 C (混合实现)**：

1. **必须实现**（满足课程要求）:
   - 2个触发器
   - 2个存储过程/函数
   - 2-3个视图
   - 保持现有的事务和索引

2. **建议实现**（提升质量）:
   - 3-5个高级索引
   - 5-8个 CHECK 约束
   - 1-2个并发控制示例

3. **可选实现**（加分项）:
   - 分区表
   - 物化视图
   - 全文搜索

## 八、后续行动

- [ ] 与用户确认实现方案
- [ ] 评估是否需要从 SQLite 迁移到 PostgreSQL
- [ ] 创建 SQL 脚本目录结构
- [ ] 逐个实现优先级 1 的特性
- [ ] 更新 GORM 代码以调用存储过程和视图
- [ ] 编写测试验证高级特性
- [ ] 更新课程设计报告文档

---

**分析结论**: 当前项目在基础数据库特性上实现良好（事务、索引、约束），但在高级特性（触发器、存储过程、视图）上存在明显缺失。建议优先实现 2个触发器 + 2-3个函数 + 2-3个视图，以满足课程设计的"体现数据库高级特性应用"要求。
